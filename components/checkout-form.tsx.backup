"use client"

import { useState, useEffect } from "react"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Alert, AlertDescription } from "@/components/ui/alert"
import { CheckCircle2, AlertCircle, Tag, Loader2 } from "lucide-react"
import { useAccount, useSendTransaction, useWaitForTransactionReceipt } from "wagmi"
import { parseEther } from "viem"
import { useCartStore } from "@/lib/cart-store"
import { useOrderStore } from "@/lib/order-store"
import { useRouter } from "next/navigation"
import { BankTransferDialog } from "@/components/bank-transfer-dialog"
import { ShippingAddressForm } from "@/components/shipping-address-form"
import { validatePromoCode, calculateDiscount, type PromoCode } from "@/lib/promo-codes"
import type { ShippingAddress } from "@/lib/address-store"
import { orderService } from "@/lib/order-service"
import { getCurrentUser } from "@/lib/auth-utils"

interface CheckoutFormProps {
  total: number
  onNeedSetup?: () => void
  canPayInstantly?: boolean
  customerType?: string
}

export function CheckoutForm({ total, onNeedSetup, canPayInstantly = true, customerType = 'retail' }: CheckoutFormProps) {
  const [mounted, setMounted] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [success, setSuccess] = useState(false)
  const [showBankTransfer, setShowBankTransfer] = useState(false)
  const [orderReference] = useState(`ORD-${Date.now()}`)
  const [promoCode, setPromoCode] = useState("")
  const [appliedPromo, setAppliedPromo] = useState<PromoCode | null>(null)
  const [promoError, setPromoError] = useState<string | null>(null)
  const [shippingAddress, setShippingAddress] = useState<Omit<ShippingAddress, "id"> | null>(null)
  const [isCreatingOrder, setIsCreatingOrder] = useState(false)
  const [createdOrderNumber, setCreatedOrderNumber] = useState<string | null>(null)
  const [paymentCurrency, setPaymentCurrency] = useState<'ETH' | 'USDC'>('ETH')

  const { items, clearCart } = useCartStore()
  const { addOrder } = useOrderStore()
  const router = useRouter()

  const { address, isConnected } = useAccount()
  const { sendTransaction, data: hash, isPending } = useSendTransaction()

  const { isLoading: isConfirming, isSuccess: isConfirmed } = useWaitForTransactionReceipt({
    hash,
  })

  const discount = appliedPromo ? calculateDiscount(total, appliedPromo) : 0
  const finalTotal = total - discount

  useEffect(() => {
    setMounted(true)
  }, [])

  // Auto-validate discount code when user stops typing
  useEffect(() => {
    if (!promoCode.trim() || appliedPromo) return
    
    const timeoutId = setTimeout(() => {
      handleApplyPromo()
    }, 1000) // Wait 1 second after user stops typing

    return () => clearTimeout(timeoutId)
  }, [promoCode, total])

  useEffect(() => {
    if (isConfirmed && hash) {
      setSuccess(true)

      addOrder({
        items: items,
        total: finalTotal,
        token: "ETH",
        transactionHash: hash,
        shippingAddress: shippingAddress,
      })

      setTimeout(() => {
        clearCart()
        router.push(`/order-confirmation?tx=${hash}`)
      }, 2000)
    }
  }, [isConfirmed, hash, finalTotal, items, addOrder, clearCart, router])

  async function handleApplyPromo(codeToValidate?: string) {
    setPromoError(null)

    const code = codeToValidate || promoCode

    if (!code.trim()) {
      setPromoError("Please enter a promo code")
      return
    }

    console.log('[Checkout] Validating discount code:', code, 'for order amount:', total)

    try {
      const result = await orderService.validateDiscount({
        code: code,
        orderAmount: total
      })

      console.log('[Checkout] Discount validation result:', result)

      if (result.valid && result.discount) {
        // Convert backend discount format to local PromoCode format
        const promo: PromoCode = {
          id: result.discount.id,
          code: result.discount.code,
          type: result.discount.discount_percentage ? 'percentage' : 'fixed',
          discount: result.discount.discount_percentage || result.discount.discount_amount || 0,
          description: result.discount.description,
          validUntil: result.discount.valid_until ? new Date(result.discount.valid_until) : undefined
        }
        console.log('[Checkout] Promo applied:', promo)
        setAppliedPromo(promo)
        setPromoCode("")
      } else {
        console.log('[Checkout] Invalid promo code:', result.error)
        setPromoError(result.error || "Invalid or expired promo code")
      }
    } catch (error) {
      console.error('[Checkout] Discount validation error:', error)
      if (error instanceof Error) {
        console.error('[Checkout] Error details:', error.message)
      }
      setPromoError("Failed to validate promo code")
    }
  }

  function handleRemovePromo() {
    setAppliedPromo(null)
    setPromoError(null)
  }

  async function handlePayment() {
    setError(null)

    if (!shippingAddress || !shippingAddress.name || !shippingAddress.addressLine1) {
      setError("Please enter a shipping address")
      return
    }

    if (!shippingAddress.email) {
      setError("Please enter your email address")
      return
    }

    if (!address) {
      setError("Please connect your wallet first")
      return
    }

    try {
      setIsCreatingOrder(true)

      // Get current user
      const user = await getCurrentUser()

      // For development mode: Use mock user if no auth
      const isDevelopment = process.env.NODE_ENV === 'development'
      if (!user && !isDevelopment) {
        setError("Please log in to continue")
        return
      }

      // Use email from shipping address form (pre-filled from profile)
      const userEmail = shippingAddress.email || user?.email || 'test@example.com'

      // Split name into first and last
      const nameParts = shippingAddress.name.split(' ')
      const firstName = nameParts[0] || ''
      const lastName = nameParts.slice(1).join(' ') || ''

      // Create order first - backend will assign wallet
      console.log('[Checkout] Creating order...')
      const orderData = await orderService.createOrder({
        items: items.map(item => ({
          product_id: item.id,
          quantity: item.quantity,
          unit_price: item.price
        })),
        shipping_address: {
          line1: shippingAddress.addressLine1,
          line2: shippingAddress.addressLine2,
          city: shippingAddress.city,
          state: shippingAddress.state,
          zip: shippingAddress.zip,
          country: shippingAddress.country || 'USA'
        },
        customer_info: {
          first_name: firstName,
          last_name: lastName,
          email: userEmail
        },
        discount_code_id: appliedPromo?.id,
        discount_amount: discount,
        payment_method: 'crypto',
        notes: null
      })

      console.log('[Checkout] Order created:', orderData.order.order_number)
      setCreatedOrderNumber(orderData.order.order_number)

      // Get assigned wallet
      const walletData = await orderService.getAssignedWallet(orderData.order.order_number)
      const merchantAddress = walletData.wallet.address

      console.log('[Checkout] Using wallet:', walletData.wallet.label, merchantAddress)

      // Initiate payment (sets payment_status to 'payment_processing')
      const paymentData = await orderService.initiatePayment(
        orderData.order.id,
        walletData.wallet.id,
        paymentCurrency
      )

      console.log('[Checkout] Payment initiated:', paymentData)

      // Send transaction based on currency
      if (paymentCurrency === 'ETH') {
        const ethAmount = paymentData.ethAmount || (finalTotal / 3000).toFixed(6)
        const amount = parseEther(ethAmount)

        sendTransaction({
          to: merchantAddress as `0x${string}`,
          value: amount,
        })
      } else if (paymentCurrency === 'USDC') {
        // USDC ERC-20 transfer
        const usdcContract = '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48'
        const usdcAmount = Math.round(finalTotal * 1000000) // 6 decimals

        // Encode transfer(address,uint256)
        const transferSelector = '0xa9059cbb'
        const paddedRecipient = merchantAddress.slice(2).padStart(64, '0')
        const paddedAmount = usdcAmount.toString(16).padStart(64, '0')
        const data = `${transferSelector}${paddedRecipient}${paddedAmount}` as `0x${string}`

        sendTransaction({
          to: usdcContract as `0x${string}`,
          data: data,
        })
      }

      setIsCreatingOrder(false)
    } catch (err) {
      console.error('[Checkout] Error:', err)
      const errorMessage = err instanceof Error ? err.message : "Payment failed. Please try again."
      setError(errorMessage)
      setIsCreatingOrder(false)
    }
  }

  if (!mounted) {
    return (
      <div className="space-y-6">
        <div className="animate-pulse space-y-4">
          <div className="h-10 bg-secondary rounded" />
          <div className="h-32 bg-secondary rounded" />
        </div>
      </div>
    )
  }

  const isProcessing = isPending || isConfirming

  return (
    <div className="space-y-6">
      {error && (
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}

      {success && (
        <Alert className="border-accent bg-accent/10">
          <CheckCircle2 className="h-4 w-4 text-accent" />
          <AlertDescription>
            <span className="font-medium">Payment successful! Redirecting...</span>
          </AlertDescription>
        </Alert>
      )}

      <ShippingAddressForm onAddressChange={setShippingAddress} />

      <div className="space-y-3">
        <div className="flex items-center gap-2">
          <Tag className="h-4 w-4 text-muted-foreground" />
          <h3 className="font-medium">Promo Code</h3>
        </div>

        {appliedPromo ? (
          <Alert className="border-green-500 bg-green-500/10">
            <CheckCircle2 className="h-4 w-4 text-green-500" />
            <AlertDescription className="flex items-center justify-between">
              <span>
                <span className="font-medium">{appliedPromo.code}</span> applied!
                {appliedPromo.type === "percentage"
                  ? ` ${appliedPromo.discount}% off`
                  : ` $${appliedPromo.discount} off`}
              </span>
              <Button variant="ghost" size="sm" onClick={handleRemovePromo} className="h-auto p-1 text-xs">
                Remove
              </Button>
            </AlertDescription>
          </Alert>
        ) : (
          <div className="space-y-2">
            <div className="flex gap-2">
              <Input
                placeholder="Enter promo code"
                value={promoCode}
                onChange={(e) => setPromoCode(e.target.value.toUpperCase())}
                onKeyDown={(e) => e.key === "Enter" && handleApplyPromo()}
                disabled={success}
              />
              <Button onClick={() => handleApplyPromo()} variant="outline" disabled={success || !promoCode.trim()}>
                Apply
              </Button>
            </div>
            {promoError && <p className="text-sm text-destructive">{promoError}</p>}
          </div>
        )}
      </div>

      <div className="space-y-3">
        <div className="p-6 rounded-lg bg-secondary/50 text-center">
          <div className="font-bold leading-[.5rem] mt-px px-px text-xl py-px">Pay Now</div>
          {appliedPromo && (
            <div className="mt-3 space-y-1 text-sm">
              <div className="flex justify-between text-muted-foreground">
                <span>Original:</span>
                <span className="line-through">${total.toFixed(2)}</span>
              </div>
              <div className="flex justify-between text-green-500 font-medium">
                <span>Discount:</span>
                <span>-${discount.toFixed(2)}</span>
              </div>
            </div>
          )}
          <div className="mt-2 text-3xl font-bold">${finalTotal.toFixed(2)}</div>
          <div className="text-sm text-muted-foreground mt-1">â‰ˆ {(finalTotal / 3000).toFixed(6)} ETH</div>
        </div>

        <div className="space-y-3">
          {/* Currency Selection */}
          {!isConnected ? (
            <appkit-button />
          ) : (
            <>
              <div className="flex gap-2 p-1 bg-secondary/50 rounded-lg">
                <Button
                  variant="ghost"
                  className={paymentCurrency === 'ETH' ? 'bg-background shadow-sm' : ''}
                  onClick={() => setPaymentCurrency('ETH')}
                  size="sm"
                  disabled={isProcessing || success || isCreatingOrder}
                >
                  Pay with ETH
                </Button>
                <Button
                  variant="ghost"
                  className={paymentCurrency === 'USDC' ? 'bg-background shadow-sm' : ''}
                  onClick={() => setPaymentCurrency('USDC')}
                  size="sm"
                  disabled={isProcessing || success || isCreatingOrder}
                >
                  Pay with USDC
                </Button>
              </div>

              <Button
                onClick={handlePayment}
                className="w-full !bg-black !text-white hover:!bg-gray-900 border border-white"
                size="lg"
                disabled={isProcessing || success || isCreatingOrder || !canPayInstantly}
              >
                {isCreatingOrder ? (
                  <>
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    Creating Order...
                  </>
                ) : isProcessing ? (
                  "Processing Payment..."
                ) : success ? (
                  "Success!"
                ) : (
                  `Pay ${finalTotal.toFixed(2)} USD with ${paymentCurrency}`
                )}
              </Button>

              {!canPayInstantly && (
                <Alert>
                  <AlertDescription className="text-sm">
                    <strong>Manual Review Required:</strong> Your order will be reviewed before payment. A member of our team will contact you shortly.
                  </AlertDescription>
                </Alert>
              )}
            </>
          )}

          <div className="relative">
            <div className="absolute inset-0 flex items-center">
              <span className="w-full border-t" />
            </div>
            <div className="relative flex justify-center text-xs uppercase">
              <span className="bg-background px-2 text-muted-foreground">Or</span>
            </div>
          </div>

          <Button
            onClick={() => setShowBankTransfer(true)}
            variant="outline"
            className="w-full"
            size="lg"
            disabled={success}
          >
            Pay by Bank Transfer
          </Button>
        </div>
      </div>

      <BankTransferDialog
        open={showBankTransfer}
        onOpenChange={setShowBankTransfer}
        total={finalTotal}
        orderNumber={orderReference}
      />
    </div>
  )
}
